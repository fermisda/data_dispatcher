{% extends "base.html" %}

{% block html_head %}
<style type="text/css">
	svg.timeline text.tooltip {display: none;}
	svg.timeline g:hover text.tooltip {display: block;}
</style>
{% endblock %}

{% block headline %}Project {{project.ID}}{% endblock %}

{% block content %}

<table class="form">
    <tr>    <th>Project ID</th>         <td>{{project.ID}}</td> </tr>
    <tr>    <th>User</th>               <td>{{project.Owner}}</td> </tr>
    <tr>    <th>Created</th>            <td>{{project.CreatedTimestamp|as_dt_utc}}</td> </tr>
    <tr>    <th>Ended</th>              
            <td>{% if not project.EndTimestamp is none %}
                    {{project.EndTimestamp|as_dt_utc}}
                {% endif %}
            </td> 
    </tr>

    <tr>    <th>Status</th>             <td><span class="{{project.State}}" style="padding: 3px">{{project.State}}</span></td> </tr>
    <tr>    <th>Query</th>              <td><pre>{{project.Query or ""}}</pre></td>
            {% if project.Query or False and not GLOBAL_MetaCatURL is none %}
                <td><a href="{{GLOBAL_MetaCatURL}}/gui/query?query={{project.quoted_query()}}&run=yes">run query</a></td>
            {% endif %}
    </tr>
    <tr>    <th>Worker timeout</th>     <td>{{project.WorkerTimeout|none_as_blank}}</td></tr>
    <tr>    <th>Project attributes</th>         <td class="nopadding">
            {% if project.Attributes|length %}
                <table class="placement attributes dense">
                    {% for name, value in project.Attributes.items() %}
                        <tr><td style="text-align: right">{{name}}:</td><td>{{value}}</td></tr>
                    {% endfor %}
                </table>
            {% endif %}
            </td> 
    </tr>
    <tr>    
            <th>Files</th>
            <td class="nopadding">
                <table class="placement dense">
                    <tr>
                    {% for state in states -%}
                        <td class="{{state}}">
                            {% if state in state_index %}
                                <a href="{{state_index[state]}}">{{state}}:&nbsp{{handle_counts_by_state[state]}}</a>
                            {% else %}
                                {{state}}:&nbsp{{handle_counts_by_state[state]}}
                            {% endif %}
                        </td>
                    {% endfor %}
                    </tr>
                </table>
                {% if not page_index is none %}
                    <p>page:{%- for p, link in page_index -%}
                                {%- if link is not none -%}
                                    &nbsp;&nbsp;<a href="{{link}}">{{p+1}}</a>
                                {%- else -%}
                                    &nbsp;&nbsp;{{p+1}}
                                {%- endif -%}
                            {%- endfor -%}
                    </p>
                {% endif %}
                <table class="data replicas">
                    <tr>
                        <th>File</th>
                        <th>File<br/>Status</th>
                        <th>Replicas<br/>(available)</th>
                        <th>Workflow<br/>Status</th>
                        <th>Worker</th>
                        <th>Attempts</th>
                    </tr>
                    {% for handle in handles %}
                        {% set did = handle.Namespace + ":" + handle.Name %}
                        {% set wf_state = handle.State %}
                        <tr id="state:{{wf_state}}">
                            <td style="text-align:left"><a href="./handle?project_id={{project.ID}}&namespace={{handle.Namespace}}&name={{handle.Name}}">{{did}}</a></td>
                            {% set file_state = handle.file_state() %}
                            <td class="{{file_state}}">{{file_state}}</td>
                            <td>{{handle.n_replicas}} ({{handle.n_available_replicas}})</td>
                            <td class="{{wf_state}}">{{wf_state}}</td>
                            <td>{{handle.WorkerID or ""}}</td>
                            <td>{{handle.Attempts}}</td>
                        </tr>
                    {% endfor %}
                </table>
            </td>
    </tr>
    <tr>
        <th>Project log</th>
        <td class="nopadding">
            <table class="data">
                <tr><th>Time</th><th>Type</th><th>Data</th></tr>
                {% for log_record in project.get_log() %}
                    <tr>
                        <td>{{log_record.T|as_dt_utc}}</td>
                        <td class="{{log_record.Type}}">{{log_record.Type}}</td>
                        <td style="text-align:left">{{ log_record.Data|format_log_data }}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </td>
    </tr>
</table>

{% endblock %}



